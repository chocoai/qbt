package com.qbt.web.support.impl;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.Resource;

import org.springframework.stereotype.Service;

import com.qbt.common.entity.PageEntity;
import com.qbt.common.enums.ErrorCodeEnum;
import com.qbt.common.exception.BusinessException;
import com.qbt.common.util.BeanUtil;
import com.qbt.common.util.Checker;
import com.qbt.persistent.entity.UserPackageTicket;
import com.qbt.persistent.entity.UserActivityPackage;
import com.qbt.persistent.entity.UserActivityOrder;
import com.qbt.service.UserActivityOrderService;
import com.qbt.service.UserActivityPackageService;
import com.qbt.service.UserPackageTicketService;
import com.qbt.web.pojo.ticket.UserActivityOrderAddReqVo;
import com.qbt.web.pojo.ticket.UserActivityOrderPageReqVo;
import com.qbt.web.pojo.ticket.UserActivityOrderVo;
import com.qbt.web.pojo.ticket.UserActivityPackageVo;
import com.qbt.web.pojo.ticket.UserPackageTicketVo;
import com.qbt.web.support.UserActivityOrderSupport;

@Service
public class UserActivityOrderSupportImpl implements UserActivityOrderSupport {

	@Resource
	UserActivityOrderService userActivityOrderService;
	
	@Resource
	UserActivityPackageService userActivityPackageService;
	
	@Resource
	UserPackageTicketService userPackageTicketService;
	
	@Override
	public List<UserActivityOrderVo> findByPage(UserActivityOrderPageReqVo reqVo) {
		PageEntity<UserActivityOrder> pageEntity = BeanUtil.pageConvert(reqVo, UserActivityOrder.class);
		
		List<UserActivityOrder> list = userActivityOrderService.findByPage(pageEntity);
		List<UserActivityOrderVo> voList = new ArrayList<UserActivityOrderVo>();
		for(UserActivityOrder act : list){
			UserActivityOrderVo vo = BeanUtil.a2b(act, UserActivityOrderVo.class);
			voList.add(vo);
		}
		reqVo.setTotalCount(pageEntity.getTotalCount());
		return voList;
	}

	@Override
	public UserActivityOrderVo findById(Integer id) {
		UserActivityOrder ticketPackageOrder = userActivityOrderService.findById(id);
		UserActivityOrderVo vo = BeanUtil.a2b(ticketPackageOrder, UserActivityOrderVo.class);
		return vo;
	}

	@Override
	public int add(UserActivityOrderAddReqVo vo) {
		UserActivityOrder order = BeanUtil.a2b(vo, UserActivityOrder.class);
		
		// add order
		int orderId = userActivityOrderService.insert(order);
		
		// add package		
		List<UserActivityPackageVo> tpvos = vo.getTicketPackageVos();
		if(tpvos != null) {
			for(UserActivityPackageVo tpvo : tpvos) {
				UserActivityPackage ticketPackage = BeanUtil.a2b(tpvo, UserActivityPackage.class);
//				ticketPackage.setOrderId(orderId);
				int packageId = userActivityPackageService.insert(ticketPackage);
				
				// add ticket
				List<UserPackageTicketVo> ticketvos = tpvo.getTicketVos();
				if(ticketvos != null) {
					for(UserPackageTicketVo ticketvo: ticketvos) {
						UserPackageTicket ticket = BeanUtil.a2b(ticketvo, UserPackageTicket.class);
						ticket.setPackageId(packageId);
						
						userPackageTicketService.insert(ticket);
					}
				}
			}
		}
		
		
		// add ticket
		
		return orderId;
	}

	@Override
	public boolean update(UserActivityOrderVo vo) {
		UserActivityOrder order = userActivityOrderService.findById(vo.getId());
		if(Checker.isEmpty(order)) {
			throw new BusinessException(ErrorCodeEnum.ERROR_VALID_FAIL, "无效的数据");
		}
		
		order.setActivityName(vo.getActivityName());
		order.setOperatorId(vo.getOperatorId());
		order.setOperatorName(vo.getOperatorName());
		order.setPayStatus(vo.getPayStatus());
		order.setProxyUser(vo.getProxyUser());
		order.setPurchaser(vo.getPurchaser());
		order.setPurchaserAddress(vo.getPurchaserAddress());
		order.setPurchaserNumber(vo.getPurchaserNumber());
		order.setType(vo.getType());
		order.setStatus(vo.getStatus());
		
		return userActivityOrderService.update(order) > 0;
	}

}

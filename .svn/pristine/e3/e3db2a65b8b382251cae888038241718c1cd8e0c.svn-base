"use strict";
angular.module("app.views")
    .controller('couponBuyCtrl', ['$scope', 'CommonService', 'Constants', '$timeout', function ($scope, CommonService, Constants, $timeout) {
        $('body').niceScroll({cursorcolor: "#337ab7"});
        //订单模型
        $scope.order = {type: "0"};

        //获取省份列表
        $scope.getProvinces = function () {
            if ($scope.provinceses && $scope.provinceses.length > 0) {
                return;
            }
            CommonService.httpRequest({
                url: '/baseSfArea/findByParentId.api?parentId=1000000',
                method: 'get'
            }).then(function (data) {
                $scope.provinceses = data.datas;
            });
        };
        //获取城市列表
        $scope.getCitieses = function () {
            if (!$scope.edit.province) {
                $scope.citieses = [];
                $scope.edit.city = "";
                return;
            }
            CommonService.httpRequest({
                url: '/baseSfArea/findByParentId.api?parentId=' + $scope.edit.province.split('|')[0],
                method: 'get'
            }).then(function (data) {
                $scope.citieses = data.datas;
            });
        };
        //获取地区列表
        $scope.getCounties = function () {
            if (!$scope.edit.city) {
                $scope.countieses = [];
                $scope.edit.country = "";
                return;
            }
            CommonService.httpRequest({
                url: '/baseSfArea/findByParentId.api?parentId=' + $scope.edit.city.split('|')[0],
                method: 'get'
            }).then(function (data) {
                $scope.countieses = data.datas;
            });
        };

        //获取省份
        $scope.getProvinces();

        //获取微信用户列表
        $scope.getWechatUser = function(num){
            CommonService.pagination({
                url : '/userWeixin/findByPage.api',
                data :{
                    pageNo : num || "1",
                    name : $scope.queryWechatName
                }
            }).then(function(data){
                $scope.wechatUsers = data.item;
                $scope.wechatUserPage = data.page;
            });
        };

        //打开微信用户选中
        $scope.openWechatUserPopup = function(item){
            $scope.getWechatUser();
            layer.open({
                type :1,
                title:'请选择微信用户',
                skin: 'layui-layer-rim', //加上边框
                area: ['620px', '640px'], //宽高
                content: $('#wechatUserPopup'),
                end: function(){
                    $scope.queryWechatName = '';
                }
            });
        }

        //选中微信用户
        $scope.selectedWechatUser = function(wechat){
            $scope.openId = wechat.openid;
            $scope.userName = wechat.name;
            $scope.mobile = wechat.mobile;
            $scope.wecatName = wechat.nickname;
            layer.closeAll();
        };

        //清除选中的微信用户
        $scope.clearWechatUser = function($event){
            //阻止事件冒泡
            $event.stopPropagation();
            $scope.openId = '';
            $scope.wecatName = '选择微信用户';
        };


        //显示订单信息确认框
        $scope.showOrder = function () {
            $timeout(function () {
                layer.open({
                    type: 1,
                    title: '订单信息',
                    area: ['460px', '520px'],
                    content: $('#showOrder'),
                    btn: ['确认', '取消'],
                    zIndex: 1000,
                    //确认
                    yes: function (index) {
                        //$scope.orderDown();
                        $scope.$apply();
                        layer.close(index);
                    },
                    //取消
                    end: function () {

                    }
                });
            });
            $('#showOrderBtn').blur();
        };

    }]);

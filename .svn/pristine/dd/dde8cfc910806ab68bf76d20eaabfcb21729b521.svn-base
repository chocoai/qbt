"use strict";
angular.module("app.views")
    .controller('couponActivityListCtrl', ['$scope', 'CommonService', function($scope, CommonService) {
        $('body').niceScroll({ cursorcolor: "#337ab7" });
        $('.date-picker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        });
        $scope.couponType = '1';
        $scope.status = '1';
        $scope.list = [];
        $scope.ruleId = '';
        $scope.getList = function(num) {
            CommonService.pagination({
                url: '/activity/findByPage.api',
                data: {
                    pageNo: num || "1",
                    name: $scope.activityName
                }
            }).then(function(data) {
                $scope.list = data.item;
                $scope.page = data.page;
            });
        }


        $scope.addActivity = function() {
            if (!$scope.couponActivityName) {
                showWarn("礼品券活动名称不能为空");
                return false;
            }
            if (!$scope.validDeadline) {
                showWarn("有效期限不能为空");
                return false;
            }
            if (!$scope.ruleId) {
                showWarn("规则名称不能为空");
                return false;
            }


            CommonService.httpRequest({
                url: '/activity/add.api',
                method: 'post',
                data: {
                    name: $scope.activityName,
                    code: $scope.activityCode,
                    startTime: new Date($scope.startTime).getTime(),
                    endTime: new Date($scope.endTime).getTime(),
                    activityStartTime: new Date($scope.activityStartTime).getTime(),
                    activityEndTime: new Date($scope.activityEndTime).getTime(),
                    maxPerOne: parseInt($scope.maxPerOne),
                    desc: $scope.desc,
                    amount: $scope.amount,
                    couponCount: parseInt($scope.couponCount),
                    status: $scope.status,
                    ruleId: parseInt($scope.ruleId)
                }
            }).then(function(data) {
                showInfo("新增成功", function() {
                    tabOpenParent({ name: 'activityIndex', url: 'activityIndex.html', displayName: '活动查询' });
                });
            });
        }

        $scope.conpunDetail = function(id) {
            localStorage.setItem("manages", id);
            tabOpenParent({ name: 'coupunCheck', url: 'coupunCheck.html', displayName: '优惠券' });
        }

        $scope.getRule = function() {
            CommonService.httpRequest({
                url: '/activityRule/list.api',
                method: 'get',
                data: {}
            }).then(function(data) {
                $scope.rules = data.datas;
            });
        }

        $scope.setAmount = function() {
            if (!!$scope.ruleId) {
                CommonService.httpRequest({
                    url: '/activityRule/detail.api',
                    method: 'get',
                    data: {
                        id: $scope.ruleId
                    }
                }).then(function(data) {
                    $scope.amount = data.datas.amount;
                });
            } else {
                $scope.amount = '';
            }
        }

        // 新增券包
        $scope.addCoupon = function() {
            tabOpenParent({ name: 'couponActivityAdd', url: 'couponActivityAdd.html', displayName: '新增券包' });
        }

        $scope.downloadActivity = function(id) {
            window.open(rBasetUrl + '/activity/coupon.api?token=' + localStorage.getItem('token') + '&activityId=' + id);
        };

        $scope.getList(1);
        $scope.getRule();

        document.onkeydown = function(event) {
            var e = event || window.event || arguments.callee.caller.arguments[0];
            if (e && e.keyCode == 13) { // enter 键
                $scope.getList();
            }
        };

    }]);